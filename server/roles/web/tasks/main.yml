---
# This playbook will install and configure webserver with Home Assistant
# https://www.home-assistant.io/docs/installation/docker/

- name: Check that the docker-compose exists
  stat:
    path: /home/pi/homeassistant/docker-compose.yml
  register: compose

- name: Down docker container
  command:
    chdir: /home/pi/homeassistant/
    cmd: docker-compose down
  when: compose.stat.exists
  become: true

- name: Create Home Assistant directory
  file:
    path: /home/pi/homeassistant/config
    state: directory
    mode: '0755'

- name: Copy Home Assistant config
  template:
    src: configuration.yaml.j2
    dest: /home/pi/homeassistant/config/configuration.yaml

- name: Copy Home Assistant docker-compose
  template:
    src: docker-compose.yml.j2
    dest: /home/pi/homeassistant/docker-compose.yml

- name: Copy mosquitto config
  template:
    src: mosquitto.conf.j2
    dest: /home/pi/homeassistant/mosquitto.conf

- name: Copy mosquitto passwd
  template:
    src: mosquitto.passwd.j2
    dest: /home/pi/homeassistant/mosquitto.passwd

- name: Run docker container
  command:
    chdir: /home/pi/homeassistant/
    cmd: docker-compose up -d
  register: container
  become: true

- debug: msg="{{ container.stdout }}"
